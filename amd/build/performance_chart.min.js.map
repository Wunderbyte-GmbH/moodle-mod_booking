{"version":3,"file":"performance_chart.min.js","sources":["../src/performance_chart.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/performance_chart\n */\n\n/* eslint-disable */\ndefine(['core/chartjs', 'core/ajax', 'jquery'], function(Chart, Ajax, $) {\n\n    let chartInstance = null;\n\n    const init = (canvasId, dataScriptId) => {\n        const canvas = document.getElementById(canvasId);\n        const dataNode = document.getElementById(dataScriptId);\n\n        if (!canvas || !dataNode) {\n            return;\n        }\n\n        let parsed;\n        try {\n            parsed = JSON.parse(dataNode.textContent);\n        } catch (e) {\n            console.error('Invalid chart data JSON:', e);\n            return;\n        }\n\n        chartInstance = createChart(canvas, parsed);\n        registerSidebarClicks();\n        registerSaveClicks();\n    };\n\n    /**\n     * Create a line chart with numeric X axis (timestamps).\n     *\n     * Dataset format:\n     * [\n     *   {\n     *     label: 'Series A',\n     *     data: [\n     *       { x: 1704067200, y: 120 },\n     *       { x: 1704067200, y: 140 },\n     *       { x: 1704153600, y: 130 }\n     *     ]\n     *   }\n     * ]\n     */\n    const createChart = (canvas, data) => {\n        const labels = data.labelsjson || '[]';\n\n        const notes = data.notesjson || '[]';\n\n        const rawdatasets = data.datasetsjson || '[]';\n\n        const datasets = rawdatasets.map(ds => ({\n            label: ds.label,\n            data: ds.data, // y-array aligned to labels\n            borderColor: ds.borderColor || ds.backgroundColor,\n            backgroundColor: 'transparent',\n            fill: false,\n            tension: 0.2,\n            pointRadius: 3,\n            pointHoverRadius: 5,\n            spanGaps: false\n        }));\n\n        return new Chart(canvas.getContext('2d'), {\n            type: 'line',\n            data: { labels, datasets },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                // IMPORTANT: remove parsing:false (it can interfere depending on Chart.js wrapper/settings)\n                plugins: {\n                    legend: { position: 'right', align: 'start' },\n                    tooltip: {\n                        callbacks: {\n                            label: function(ctx) {\n                                return ctx.dataset.label + ': ' + ctx.parsed.y + ' (' + ctx.label + ')';\n                            },\n                            afterBody: function(items) {\n                                // Show note for the hovered x-index (run index).\n                                const idx = items && items.length ? items[0].dataIndex : undefined;\n                                if (idx === undefined) {\n                                    return [];\n                                }\n\n                                const note = (notes[idx] || '').toString().trim();\n                                return note ? ['Note: ' + note] : [];\n                            }\n                        }\n                    }\n                },\n                scales: {\n                    x: { type: 'category' }, // equal spacing\n                    y: {\n                        beginAtZero: true,\n                        title: { display: true, text: 'Time (ms)' }\n                    }\n                }\n            }\n        });\n    };\n\n    const updateChart = (data) => {\n        if (!chartInstance) {\n            return;\n        }\n\n        try {\n            const labels = JSON.parse(data.labelsjson || '[]');\n            const datasets = JSON.parse(data.datasetsjson);\n\n            // Normalize datasets to {x, y}\n            chartInstance.data.labels = labels;\n            chartInstance.data.datasets = datasets.map(ds => ({\n                label: ds.label,\n                data: ds.data,\n                borderColor: ds.borderColor || ds.backgroundColor,\n                backgroundColor: 'transparent',\n                fill: false,\n                tension: 0.2,\n                pointRadius: 3,\n                pointHoverRadius: 5,\n                spanGaps: false\n            }));\n\n            chartInstance.update();\n        } catch (e) {\n            console.error('Failed to update chart data:', e);\n        }\n    };\n\n    const registerSidebarClicks = () => {\n        $('.booking-sidebar-item a').on('click', function(e) {\n            e.preventDefault();\n\n            const hash = $(this).data('hash');\n            if (!hash) {\n                return;\n            }\n\n            Ajax.call([{\n                methodname: 'mod_booking_get_performance_chart',\n                args: { value: hash },\n                done: function(response) {\n                    updateChart(response);\n                },\n                fail: function(error) {\n                    console.error('Error loading chart data', error);\n                }\n            }]);\n        });\n    };\n\n    const registerSaveClicks = () => {\n        $(document).on('click', '[data-action=\"savemeasurement\"]', function(e) {\n            e.preventDefault();\n\n            const $btn = $(this);\n            const $editor = $btn.closest('.card-body');\n\n            const measurementid = $btn.data('id');\n            const note = $editor.find('textarea').val();\n\n            if (!measurementid) {\n                return;\n            }\n\n            Ajax.call([{\n                methodname: 'mod_booking_save_measurement',\n                args: {\n                    measurementid: measurementid,\n                    note: note\n                }\n            }])[0].then(function(response) {\n                // Optional UX feedback\n                $editor.closest('.collapse').collapse('hide');\n\n                // Optional: visual success hint\n                $btn.blur();\n                window.location.reload();\n            }).catch(function(error) {\n                console.error('Saving measurement failed', error);\n            });\n        });\n    };\n\n    return {\n        init,\n        updateChart\n    };\n});"],"names":["define","Chart","Ajax","$","chartInstance","createChart","canvas","data","labels","labelsjson","notes","notesjson","datasets","datasetsjson","map","ds","label","borderColor","backgroundColor","fill","tension","pointRadius","pointHoverRadius","spanGaps","getContext","type","options","responsive","maintainAspectRatio","plugins","legend","position","align","tooltip","callbacks","ctx","dataset","parsed","y","afterBody","items","idx","length","dataIndex","undefined","note","toString","trim","scales","x","beginAtZero","title","display","text","updateChart","JSON","parse","update","e","console","error","registerSidebarClicks","on","preventDefault","hash","this","call","methodname","args","value","done","response","fail","registerSaveClicks","document","$btn","$editor","closest","measurementid","find","val","then","collapse","blur","window","location","reload","catch","init","canvasId","dataScriptId","getElementById","dataNode","textContent"],"mappings":"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"}