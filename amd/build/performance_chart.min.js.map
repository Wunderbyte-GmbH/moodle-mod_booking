{"version":3,"file":"performance_chart.min.js","sources":["../src/performance_chart.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/performance_chart\n */\n\n/* eslint-disable */\ndefine(['core/chartjs', 'core/ajax', 'jquery'], function(Chart, Ajax, $) {\n\n    let chartInstance = null;\n\n    const init = (canvasId, dataScriptId) => {\n        const canvas = document.getElementById(canvasId);\n        const dataNode = document.getElementById(dataScriptId);\n\n        if (!canvas || !dataNode) {\n            return;\n        }\n\n        let parsed;\n        try {\n            parsed = JSON.parse(dataNode.textContent);\n        } catch (e) {\n            console.error('Invalid chart data JSON:', e);\n            return;\n        }\n\n        chartInstance = createChart(canvas, parsed);\n        registerSidebarClicks();\n    };\n\n    /**\n     * Create a line chart with numeric X axis (timestamps).\n     *\n     * Dataset format:\n     * [\n     *   {\n     *     label: 'Series A',\n     *     data: [\n     *       { x: 1704067200, y: 120 },\n     *       { x: 1704067200, y: 140 },\n     *       { x: 1704153600, y: 130 }\n     *     ]\n     *   }\n     * ]\n     */\n    const createChart = (canvas, data) => {\n        const datasets = (data.datasets || []).map(ds => ({\n            label: ds.label,\n            data: ds.data,\n            borderColor: ds.borderColor || ds.backgroundColor,\n            backgroundColor: 'transparent',\n            fill: false,\n            tension: 0.2,\n            pointRadius: 3,\n            pointHoverRadius: 5\n        }));\n\n        return new Chart(canvas.getContext('2d'), {\n            type: 'line',\n            data: {\n                datasets\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                parsing: false,\n                plugins: {\n                    legend: {\n                        position: 'right',\n                        align: 'start'\n                    },\n                    tooltip: {\n                        callbacks: {\n                            label: function(ctx) {\n                                return ctx.dataset.label + ': ' + ctx.parsed.y;\n                            }\n                        }\n                    }\n                },\n                scales: {\n                    x: {\n                        type: 'linear',\n                        ticks: {\n                            callback: function(value) {\n                                const date = new Date(value * 1000);\n                                return date.toISOString().slice(0, 10);\n                            }\n                        }\n                    },\n                    y: {\n                        beginAtZero: true,\n                        title: {\n                            display: true,\n                            text: 'Time (ms)'\n                        }\n                    }\n                }\n            }\n        });\n    };\n\n    const updateChart = (data) => {\n        if (!chartInstance) {\n            return;\n        }\n\n        try {\n            let datasets = JSON.parse(data.datasetsjson);\n\n            // Normalize datasets to {x, y}\n            datasets = datasets.map(ds => {\n                if (!Array.isArray(ds.data)) {\n                    return ds;\n                }\n\n                // If already {x, y}, keep as-is\n                if (ds.data.length && typeof ds.data[0] === 'object' && ds.data[0] !== null) {\n                    return ds;\n                }\n\n                // Otherwise, convert from indexed format\n                const normalizedData = ds.data\n                    .map((y, index) => {\n                        const x = chartInstance.data.datasets[0]?.data[index]?.x;\n                        if (x == null || y == null) {\n                            return null;\n                        }\n                        return { x, y };\n                    })\n                    .filter(p => p !== null);\n\n                return Object.assign({}, ds, { data: normalizedData });\n            });\n\n            chartInstance.data.datasets = datasets;\n            chartInstance.update();\n\n        } catch (e) {\n            console.error('Failed to update chart data:', e);\n        }\n    };\n\n    const registerSidebarClicks = () => {\n        $('.booking-sidebar-item a').on('click', function(e) {\n            e.preventDefault();\n\n            const hash = $(this).data('hash');\n            if (!hash) {\n                return;\n            }\n\n            Ajax.call([{\n                methodname: 'mod_booking_get_performance_chart',\n                args: { value: hash },\n                done: function(response) {\n                    updateChart(response);\n                },\n                fail: function(error) {\n                    console.error('Error loading chart data', error);\n                }\n            }]);\n        });\n    };\n\n    return {\n        init,\n        updateChart\n    };\n});"],"names":["define","Chart","Ajax","$","chartInstance","createChart","canvas","data","datasets","map","ds","label","borderColor","backgroundColor","fill","tension","pointRadius","pointHoverRadius","getContext","type","options","responsive","maintainAspectRatio","parsing","plugins","legend","position","align","tooltip","callbacks","ctx","dataset","parsed","y","scales","x","ticks","callback","value","Date","toISOString","slice","beginAtZero","title","display","text","updateChart","JSON","parse","datasetsjson","Array","isArray","length","normalizedData","index","_chartInstance$data$d","_chartInstance$data$d2","filter","p","Object","assign","update","e","console","error","registerSidebarClicks","on","preventDefault","hash","this","call","methodname","args","done","response","fail","init","canvasId","dataScriptId","document","getElementById","dataNode","textContent"],"mappings":"AAoBAA,uCAAO,CAAC,eAAgB,YAAa,WAAW,SAASC,MAAOC,KAAMC,OAE9DC,cAAgB,WAqCdC,YAAc,CAACC,OAAQC,cACnBC,UAAYD,KAAKC,UAAY,IAAIC,KAAIC,MACvCC,MAAOD,GAAGC,MACVJ,KAAMG,GAAGH,KACTK,YAAaF,GAAGE,aAAeF,GAAGG,gBAClCA,gBAAiB,cACjBC,MAAM,EACNC,QAAS,GACTC,YAAa,EACbC,iBAAkB,aAGf,IAAIhB,MAAMK,OAAOY,WAAW,MAAO,CACtCC,KAAM,OACNZ,KAAM,CACFC,SAAAA,UAEJY,QAAS,CACLC,YAAY,EACZC,qBAAqB,EACrBC,SAAS,EACTC,QAAS,CACLC,OAAQ,CACJC,SAAU,QACVC,MAAO,SAEXC,QAAS,CACLC,UAAW,CACPlB,MAAO,SAASmB,YACLA,IAAIC,QAAQpB,MAAQ,KAAOmB,IAAIE,OAAOC,MAK7DC,OAAQ,CACJC,EAAG,CACChB,KAAM,SACNiB,MAAO,CACHC,SAAU,SAASC,cACF,IAAIC,KAAa,IAARD,OACVE,cAAcC,MAAM,EAAG,OAI/CR,EAAG,CACCS,aAAa,EACbC,MAAO,CACHC,SAAS,EACTC,KAAM,mBAQxBC,YAAevC,UACZH,sBAKGI,SAAWuC,KAAKC,MAAMzC,KAAK0C,cAG/BzC,SAAWA,SAASC,KAAIC,SACfwC,MAAMC,QAAQzC,GAAGH,aACXG,MAIPA,GAAGH,KAAK6C,QAAgC,iBAAf1C,GAAGH,KAAK,IAAkC,OAAfG,GAAGH,KAAK,UACrDG,SAIL2C,eAAiB3C,GAAGH,KACrBE,KAAI,CAACwB,EAAGqB,gEACCnB,gCAAI/B,cAAcG,KAAKC,SAAS,oEAA5B+C,sBAAgChD,KAAK+C,gDAArCE,uBAA6CrB,SAC9C,MAALA,GAAkB,MAALF,EACN,KAEJ,CAAEE,EAAAA,EAAGF,EAAAA,MAEfwB,QAAOC,GAAW,OAANA,WAEVC,OAAOC,OAAO,GAAIlD,GAAI,CAAEH,KAAM8C,oBAGzCjD,cAAcG,KAAKC,SAAWA,SAC9BJ,cAAcyD,SAEhB,MAAOC,GACLC,QAAQC,MAAM,+BAAgCF,KAIhDG,sBAAwB,KAC1B9D,EAAE,2BAA2B+D,GAAG,SAAS,SAASJ,GAC9CA,EAAEK,uBAEIC,KAAOjE,EAAEkE,MAAM9D,KAAK,QACrB6D,MAILlE,KAAKoE,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CAAElC,MAAO8B,MACfK,KAAM,SAASC,UACX5B,YAAY4B,WAEhBC,KAAM,SAASX,OACXD,QAAQC,MAAM,2BAA4BA,qBAMnD,CACHY,KA3JS,CAACC,SAAUC,sBACdxE,OAASyE,SAASC,eAAeH,UACjCI,SAAWF,SAASC,eAAeF,kBAEpCxE,SAAW2E,oBAIZjD,WAEAA,OAASe,KAAKC,MAAMiC,SAASC,aAC/B,MAAOpB,eACLC,QAAQC,MAAM,2BAA4BF,GAI9C1D,cAAgBC,YAAYC,OAAQ0B,QACpCiC,yBA2IAnB,YAAAA"}