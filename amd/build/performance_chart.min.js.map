{"version":3,"file":"performance_chart.min.js","sources":["../src/performance_chart.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/performance_chart\n */\n\n/* eslint-disable */\ndefine(['core/chartjs', 'core/ajax', 'jquery'], function(Chart, Ajax, $) {\n\n    let chartInstance = null;\n\n    const init = (canvasId, dataScriptId) => {\n        const canvas = document.getElementById(canvasId);\n        const dataNode = document.getElementById(dataScriptId);\n\n        if (!canvas || !dataNode) {\n            return;\n        }\n\n        let parsed;\n        try {\n            parsed = JSON.parse(dataNode.textContent);\n        } catch (e) {\n            console.error('Invalid chart data JSON:', e);\n            return;\n        }\n\n        chartInstance = createChart(canvas, parsed);\n        registerSidebarClicks();\n    };\n\n    /**\n     * Create a line chart with numeric X axis (timestamps).\n     *\n     * Dataset format:\n     * [\n     *   {\n     *     label: 'Series A',\n     *     data: [\n     *       { x: 1704067200, y: 120 },\n     *       { x: 1704067200, y: 140 },\n     *       { x: 1704153600, y: 130 }\n     *     ]\n     *   }\n     * ]\n     */\n    const createChart = (canvas, data) => {\n        // Support both formats:\n        // 1) { labels: [], datasets: [] }\n        // 2) { labelsjson: \"[]\", datasetsjson: \"[]\" }\n        const labels = Array.isArray(data.labels)\n            ? data.labels\n            : JSON.parse(data.labelsjson || '[]');\n\n        const rawdatasets = Array.isArray(data.datasets)\n            ? data.datasets\n            : JSON.parse(data.datasetsjson || '[]');\n\n        const datasets = rawdatasets.map(ds => ({\n            label: ds.label,\n            data: ds.data, // y-array aligned to labels\n            borderColor: ds.borderColor || ds.backgroundColor,\n            backgroundColor: 'transparent',\n            fill: false,\n            tension: 0.2,\n            pointRadius: 3,\n            pointHoverRadius: 5,\n            spanGaps: false\n        }));\n\n        return new Chart(canvas.getContext('2d'), {\n            type: 'line',\n            data: { labels, datasets },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                // IMPORTANT: remove parsing:false (it can interfere depending on Chart.js wrapper/settings)\n                plugins: {\n                    legend: { position: 'right', align: 'start' },\n                    tooltip: {\n                        callbacks: {\n                            label: function(ctx) {\n                                return ctx.dataset.label + ': ' + ctx.parsed.y + ' (' + ctx.label + ')';\n                            }\n                        }\n                    }\n                },\n                scales: {\n                    x: { type: 'category' }, // equal spacing\n                    y: {\n                        beginAtZero: true,\n                        title: { display: true, text: 'Time (ms)' }\n                    }\n                }\n            }\n        });\n    };\n\n    const updateChart = (data) => {\n        if (!chartInstance) {\n            return;\n        }\n\n        try {\n            const labels = JSON.parse(data.labelsjson || '[]');\n            const datasets = JSON.parse(data.datasetsjson);\n\n            // Normalize datasets to {x, y}\n            chartInstance.data.labels = labels;\n            chartInstance.data.datasets = datasets.map(ds => ({\n                label: ds.label,\n                data: ds.data,\n                borderColor: ds.borderColor || ds.backgroundColor,\n                backgroundColor: 'transparent',\n                fill: false,\n                tension: 0.2,\n                pointRadius: 3,\n                pointHoverRadius: 5,\n                spanGaps: false\n            }));\n\n            chartInstance.update();\n        } catch (e) {\n            console.error('Failed to update chart data:', e);\n        }\n    };\n\n    const registerSidebarClicks = () => {\n        $('.booking-sidebar-item a').on('click', function(e) {\n            e.preventDefault();\n\n            const hash = $(this).data('hash');\n            if (!hash) {\n                return;\n            }\n\n            Ajax.call([{\n                methodname: 'mod_booking_get_performance_chart',\n                args: { value: hash },\n                done: function(response) {\n                    updateChart(response);\n                },\n                fail: function(error) {\n                    console.error('Error loading chart data', error);\n                }\n            }]);\n        });\n    };\n\n    return {\n        init,\n        updateChart\n    };\n});"],"names":["define","Chart","Ajax","$","chartInstance","createChart","canvas","data","labels","Array","isArray","JSON","parse","labelsjson","datasets","datasetsjson","map","ds","label","borderColor","backgroundColor","fill","tension","pointRadius","pointHoverRadius","spanGaps","getContext","type","options","responsive","maintainAspectRatio","plugins","legend","position","align","tooltip","callbacks","ctx","dataset","parsed","y","scales","x","beginAtZero","title","display","text","updateChart","update","e","console","error","registerSidebarClicks","on","preventDefault","hash","this","call","methodname","args","value","done","response","fail","init","canvasId","dataScriptId","document","getElementById","dataNode","textContent"],"mappings":"AAoBAA,uCAAO,CAAC,eAAgB,YAAa,WAAW,SAASC,MAAOC,KAAMC,OAE9DC,cAAgB,WAqCdC,YAAc,CAACC,OAAQC,cAInBC,OAASC,MAAMC,QAAQH,KAAKC,QAC5BD,KAAKC,OACLG,KAAKC,MAAML,KAAKM,YAAc,MAM9BC,UAJcL,MAAMC,QAAQH,KAAKO,UACjCP,KAAKO,SACLH,KAAKC,MAAML,KAAKQ,cAAgB,OAETC,KAAIC,MAC7BC,MAAOD,GAAGC,MACVX,KAAMU,GAAGV,KACTY,YAAaF,GAAGE,aAAeF,GAAGG,gBAClCA,gBAAiB,cACjBC,MAAM,EACNC,QAAS,GACTC,YAAa,EACbC,iBAAkB,EAClBC,UAAU,aAGP,IAAIxB,MAAMK,OAAOoB,WAAW,MAAO,CACtCC,KAAM,OACNpB,KAAM,CAAEC,OAAAA,OAAQM,SAAAA,UAChBc,QAAS,CACLC,YAAY,EACZC,qBAAqB,EAErBC,QAAS,CACLC,OAAQ,CAAEC,SAAU,QAASC,MAAO,SACpCC,QAAS,CACLC,UAAW,CACPlB,MAAO,SAASmB,YACLA,IAAIC,QAAQpB,MAAQ,KAAOmB,IAAIE,OAAOC,EAAI,KAAOH,IAAInB,MAAQ,QAKpFuB,OAAQ,CACJC,EAAG,CAAEf,KAAM,YACXa,EAAG,CACCG,aAAa,EACbC,MAAO,CAAEC,SAAS,EAAMC,KAAM,mBAO5CC,YAAexC,UACZH,wBAKKI,OAASG,KAAKC,MAAML,KAAKM,YAAc,MACvCC,SAAWH,KAAKC,MAAML,KAAKQ,cAGjCX,cAAcG,KAAKC,OAASA,OAC5BJ,cAAcG,KAAKO,SAAWA,SAASE,KAAIC,MACvCC,MAAOD,GAAGC,MACVX,KAAMU,GAAGV,KACTY,YAAaF,GAAGE,aAAeF,GAAGG,gBAClCA,gBAAiB,cACjBC,MAAM,EACNC,QAAS,GACTC,YAAa,EACbC,iBAAkB,EAClBC,UAAU,MAGdrB,cAAc4C,SAChB,MAAOC,GACLC,QAAQC,MAAM,+BAAgCF,KAIhDG,sBAAwB,KAC1BjD,EAAE,2BAA2BkD,GAAG,SAAS,SAASJ,GAC9CA,EAAEK,uBAEIC,KAAOpD,EAAEqD,MAAMjD,KAAK,QACrBgD,MAILrD,KAAKuD,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,CAAEC,MAAOL,MACfM,KAAM,SAASC,UACXf,YAAYe,WAEhBC,KAAM,SAASZ,OACXD,QAAQC,MAAM,2BAA4BA,qBAMnD,CACHa,KA3IS,CAACC,SAAUC,sBACd5D,OAAS6D,SAASC,eAAeH,UACjCI,SAAWF,SAASC,eAAeF,kBAEpC5D,SAAW+D,oBAIZ9B,WAEAA,OAAS5B,KAAKC,MAAMyD,SAASC,aAC/B,MAAOrB,eACLC,QAAQC,MAAM,2BAA4BF,GAI9C7C,cAAgBC,YAAYC,OAAQiC,QACpCa,yBA2HAL,YAAAA"}