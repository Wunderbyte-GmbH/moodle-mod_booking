{"version":3,"file":"modal_init.min.js","sources":["../src/modal_init.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/modal_init\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\n/**\n * Gets called from mustache template.\n * @param {int} optionid\n */\nexport const init = (optionid = null) => {\n\n    let spinners = [];\n    if (optionid === null) {\n        spinners = document.querySelectorAll('[id^=bo_modal_spinner]');\n    } else {\n        spinners = [document.querySelector('[id^=\"bo_modal_spinner_' + optionid + '_\"]')];\n    }\n    spinners.forEach((spinner) => {\n        const optionid = spinner.dataset.optionid;\n        const userid = spinner.dataset.userid ?? 0;\n\n        respondToVisibility(optionid, userid, getBookingOptionDescription);\n    });\n};\n\n/**\n * React on visibility change.\n * @param {int} optionid\n * @param {int} userid\n * @param {function} callback\n */\nfunction respondToVisibility(optionid, userid, callback) {\n    let element = document.getElementById('bo_modal_spinner_' + optionid);\n\n    var observer = new MutationObserver(function() {\n        if (!isHidden(element)) {\n            this.disconnect();\n            callback(optionid, userid);\n        }\n    });\n\n    // We look if we find a hidden parent. If not, we load right away.\n    while (element !== null) {\n        if (!isHidden(element)) {\n            element = element.parentElement;\n        } else {\n            if (element.dataset.observed) {\n                return;\n            }\n\n            observer.observe(element, {attributes: true});\n            element.dataset.observed = true;\n            return;\n        }\n    }\n    callback(optionid, userid);\n}\n\n/**\n * Function to check visibility of element.\n * @param {*} el\n * @returns {boolean}\n */\nfunction isHidden(el) {\n    var style = window.getComputedStyle(el);\n    return ((style.display === 'none') || (style.visibility === 'hidden'));\n}\n\n/**\n * Reloads the rendered table and sets it to the div with the right identifier.\n * @param {int} optionid\n * @param {int} userid\n */\nexport const getBookingOptionDescription = (\n    optionid,\n    userid) => {\n\n    let description = document.getElementById('bo_modal_description_' + optionid);\n    let spinner = document.querySelector('#bo_modal_spinner_' + optionid + ' .spinner-border');\n\n    if (spinner) {\n        spinner.classList.remove('hidden');\n    }\n    if (description) {\n        description.classList.add('hidden');\n    }\n\n    Ajax.call([{\n        methodname: \"mod_booking_get_booking_option_description\",\n        args: {\n            'optionid': optionid,\n            'userid': userid\n        },\n        done: function(res) {\n\n            let spinner = document.querySelector('#bo_modal_spinner_' + optionid + ' .spinner-border');\n            let description = document.getElementById('bo_modal_description_' + optionid);\n\n            const jsonobject = JSON.parse(res.content);\n\n            Templates.renderForPromise(res.template, jsonobject).then(({html, js}) => {\n\n                Templates.appendNodeContents('#bo_modal_description_' + optionid, html, js);\n\n                spinner.classList.add('hidden');\n                description.classList.remove('hidden');\n\n                return true;\n            }).catch(ex => {\n                Notification.addNotification({\n                    message: 'failed rendering ' + ex,\n                    type: \"danger\"\n                });\n            });\n\n            spinner.classList.add('hidden');\n            description.classList.remove('hidden');\n            return true;\n        },\n        fail: function(err) {\n            // eslint-disable-next-line no-console\n            console.log(err);\n            spinner.classList.add('hidden');\n            description.classList.remove('hidden');\n        }\n    }]);\n};\n"],"names":["respondToVisibility","optionid","userid","callback","element","document","getElementById","observer","MutationObserver","isHidden","disconnect","dataset","observed","observe","attributes","parentElement","el","style","window","getComputedStyle","display","visibility","spinners","querySelectorAll","querySelector","forEach","spinner","getBookingOptionDescription","description","classList","remove","add","call","methodname","args","done","res","jsonobject","JSON","parse","content","renderForPromise","template","then","_ref","html","js","appendNodeContents","catch","ex","addNotification","message","type","fail","err","console","log"],"mappings":";;;;;sQAmDSA,oBAAoBC,SAAUC,OAAQC,cACvCC,QAAUC,SAASC,eAAe,oBAAsBL,kBAExDM,SAAW,IAAIC,kBAAiB,WAC3BC,SAASL,gBACLM,aACLP,SAASF,SAAUC,YAKR,OAAZE,SAAkB,IAChBK,SAASL,SAEP,IACCA,QAAQO,QAAQC,uBAIpBL,SAASM,QAAQT,QAAS,CAACU,YAAY,SACvCV,QAAQO,QAAQC,UAAW,GAP3BR,QAAUA,QAAQW,cAW1BZ,SAASF,SAAUC,iBAQdO,SAASO,QACVC,MAAQC,OAAOC,iBAAiBH,UACT,SAAlBC,MAAMG,SAA6C,WAArBH,MAAMI,yBAxD7B,eAACpB,gEAAW,KAExBqB,SAAW,GAEXA,SADa,OAAbrB,SACWI,SAASkB,iBAAiB,0BAE1B,CAAClB,SAASmB,cAAc,0BAA4BvB,SAAW,QAE9EqB,SAASG,SAASC,oCAId1B,oBAHiB0B,QAAQf,QAAQV,uCAClByB,QAAQf,QAAQT,8DAAU,EAEHyB,uCAoDjCA,4BAA8B,CACvC1B,SACAC,cAEI0B,YAAcvB,SAASC,eAAe,wBAA0BL,UAChEyB,QAAUrB,SAASmB,cAAc,qBAAuBvB,SAAW,oBAEnEyB,SACAA,QAAQG,UAAUC,OAAO,UAEzBF,aACAA,YAAYC,UAAUE,IAAI,wBAGzBC,KAAK,CAAC,CACPC,WAAY,6CACZC,KAAM,UACUjC,gBACFC,QAEdiC,KAAM,SAASC,SAEPV,QAAUrB,SAASmB,cAAc,qBAAuBvB,SAAW,oBACnE2B,YAAcvB,SAASC,eAAe,wBAA0BL,gBAE9DoC,WAAaC,KAAKC,MAAMH,IAAII,mCAExBC,iBAAiBL,IAAIM,SAAUL,YAAYM,MAAKC,WAACC,KAACA,KAADC,GAAOA,mCAEpDC,mBAAmB,yBAA2B9C,SAAU4C,KAAMC,IAExEpB,QAAQG,UAAUE,IAAI,UACtBH,YAAYC,UAAUC,OAAO,WAEtB,KACRkB,OAAMC,2BACQC,gBAAgB,CACzBC,QAAS,oBAAsBF,GAC/BG,KAAM,cAId1B,QAAQG,UAAUE,IAAI,UACtBH,YAAYC,UAAUC,OAAO,WACtB,GAEXuB,KAAM,SAASC,KAEXC,QAAQC,IAAIF,KACZ5B,QAAQG,UAAUE,IAAI,UACtBH,YAAYC,UAAUC,OAAO"}