{"version":3,"file":"modal_init.min.js","sources":["../src/modal_init.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/modal_init\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\n/**\n * Gets called from mustache template.\n * @param {int} optionid\n */\nexport const init = (optionid = null) => {\n\n    let spinners = [];\n    if (optionid === null) {\n        spinners = document.querySelectorAll('[id^=bo_modal_spinner]');\n    } else {\n        spinners = [document.querySelector('[id^=\"bo_modal_spinner_' + optionid + '_\"]')];\n    }\n    spinners.forEach((spinner) => {\n        const optionid = spinner.dataset.optionid;\n        const userid = spinner.dataset.userid ?? 0;\n\n        respondToVisibility(optionid, userid, getBookingOptionDescription);\n    });\n};\n\n/**\n * React on visibility change.\n * @param {int} optionid\n * @param {int} userid\n * @param {function} callback\n */\nfunction respondToVisibility(optionid, userid, callback) {\n    let element = document.getElementById('bo_modal_spinner_' + optionid);\n\n    var observer = new MutationObserver(function() {\n        if (!isHidden(element)) {\n            this.disconnect();\n            callback(optionid, userid);\n        }\n    });\n\n    // We look if we find a hidden parent. If not, we load right away.\n    while (element !== null) {\n        if (!isHidden(element)) {\n            element = element.parentElement;\n        } else {\n            if (element.dataset.observed) {\n                return;\n            }\n\n            observer.observe(element, {attributes: true});\n            element.dataset.observed = true;\n            return;\n        }\n    }\n    callback(optionid, userid);\n}\n\n/**\n * Function to check visibility of element.\n * @param {*} el\n * @returns {boolean}\n */\nfunction isHidden(el) {\n    var style = window.getComputedStyle(el);\n    return ((style.display === 'none') || (style.visibility === 'hidden'));\n}\n\n/**\n * Reloads the rendered table and sets it to the div with the right identifier.\n * @param {int} optionid\n * @param {int} userid\n */\nexport const getBookingOptionDescription = (\n    optionid,\n    userid) => {\n\n    let description = document.getElementById('bo_modal_description_' + optionid);\n    let spinner = document.querySelector('#bo_modal_spinner_' + optionid + ' .spinner-border');\n\n    if (spinner) {\n        spinner.classList.remove('hidden');\n    }\n    if (description) {\n        description.classList.add('hidden');\n    }\n\n    Ajax.call([{\n        methodname: \"mod_booking_get_booking_option_description\",\n        args: {\n            'optionid': optionid,\n            'userid': userid\n        },\n        done: function(res) {\n\n            let spinner = document.querySelector('#bo_modal_spinner_' + optionid + ' .spinner-border');\n            let description = document.getElementById('bo_modal_description_' + optionid);\n\n            const jsonobject = JSON.parse(res.content);\n\n            Templates.renderForPromise(res.template, jsonobject).then(({html, js}) => {\n\n                Templates.appendNodeContents('#bo_modal_description_' + optionid, html, js);\n\n                spinner.classList.add('hidden');\n                description.classList.remove('hidden');\n\n                return true;\n            }).catch(ex => {\n                Notification.addNotification({\n                    message: 'failed rendering ' + ex,\n                    type: \"danger\"\n                });\n            });\n\n            spinner.classList.add('hidden');\n            description.classList.remove('hidden');\n            return true;\n        },\n        fail: function(err) {\n            // eslint-disable-next-line no-console\n            console.log(err);\n            spinner.classList.add('hidden');\n            description.classList.remove('hidden');\n        }\n    }]);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","_ajax","_templates","_notification","isHidden","el","style","window","getComputedStyle","display","visibility","_exports","init","optionid","arguments","length","undefined","spinners","document","querySelectorAll","querySelector","forEach","spinner","userid","callback","element","getElementById","observer","MutationObserver","this","disconnect","dataset","observed","observe","attributes","parentElement","respondToVisibility","getBookingOptionDescription","description","classList","remove","add","Ajax","call","methodname","args","done","res","jsonobject","JSON","parse","content","Templates","renderForPromise","template","then","_ref","html","js","appendNodeContents","catch","ex","Notification","addNotification","message","type","fail","err","console","log"],"mappings":"gJAuB6C,SAAAA,uBAAAC,YAAAA,KAAAA,IAAAC,WAAAD,KAAAE,QAAAF;;;;;uHAF7CG,MAAAJ,uBAAAI,OACAC,WAAAL,uBAAAK,YACAC,cAAAN,uBAAAM,eA4DA,SAASC,SAASC,IACd,IAAIC,MAAQC,OAAOC,iBAAiBH,IACpC,MAA2B,SAAlBC,MAAMG,SAA6C,WAArBH,MAAMI,WA1C/CC,SAAAC,KAdkB,WAAqB,IAApBC,SAAQC,UAAAC,eAAAC,IAAAF,aAAAA,aAAG,KAExBG,SAAW,GAEXA,SADa,OAAbJ,SACWK,SAASC,iBAAiB,0BAE1B,CAACD,SAASE,cAAc,0BAA4BP,SAAW,QAE9EI,SAASI,SAASC,WActB,SAA6BT,SAAUU,OAAQC,UAC3C,IAAIC,QAAUP,SAASQ,eAAe,oBAAsBb,UAE5D,IAAIc,SAAW,IAAIC,kBAAiB,WAC3BxB,SAASqB,WACVI,KAAKC,aACLN,SAASX,SAAUU,YAK3B,KAAmB,OAAZE,SAAkB,CACrB,GAAKrB,SAASqB,SAEP,CACH,GAAIA,QAAQM,QAAQC,SAChB,OAKJ,OAFAL,SAASM,QAAQR,QAAS,CAACS,YAAY,SACvCT,QAAQM,QAAQC,UAAW,GAP3BP,QAAUA,QAAQU,cAW1BX,SAASX,SAAUU,QAlCfa,CAHiBd,QAAQS,QAAQlB,SAClBS,QAAQS,QAAQR,QAAU,EAEHc,4BAA4B,KAoDnE,MAAMA,4BAA8BA,CACvCxB,SACAU,UAEA,IAAIe,YAAcpB,SAASQ,eAAe,wBAA0Bb,UAChES,QAAUJ,SAASE,cAAc,qBAAuBP,SAAW,oBAEnES,SACAA,QAAQiB,UAAUC,OAAO,UAEzBF,aACAA,YAAYC,UAAUE,IAAI,UAG9BC,cAAKC,KAAK,CAAC,CACPC,WAAY,6CACZC,KAAM,CACFhC,SAAYA,SACZU,OAAUA,QAEduB,KAAM,SAASC,KAEX,IAAIzB,QAAUJ,SAASE,cAAc,qBAAuBP,SAAW,oBACnEyB,YAAcpB,SAASQ,eAAe,wBAA0Bb,UAEpE,MAAMmC,WAAaC,KAAKC,MAAMH,IAAII,SAmBlC,OAjBAC,mBAAUC,iBAAiBN,IAAIO,SAAUN,YAAYO,MAAKC,OAAgB,IAAfC,KAACA,KAAIC,GAAEA,IAAGF,KAOjE,OALAJ,mBAAUO,mBAAmB,yBAA2B9C,SAAU4C,KAAMC,IAExEpC,QAAQiB,UAAUE,IAAI,UACtBH,YAAYC,UAAUC,OAAO,WAEtB,CAAI,IACZoB,OAAMC,KACLC,sBAAaC,gBAAgB,CACzBC,QAAS,oBAAsBH,GAC/BI,KAAM,UACR,IAGN3C,QAAQiB,UAAUE,IAAI,UACtBH,YAAYC,UAAUC,OAAO,WACtB,GAEX0B,KAAM,SAASC,KAEXC,QAAQC,IAAIF,KACZ7C,QAAQiB,UAAUE,IAAI,UACtBH,YAAYC,UAAUC,OAAO,aAElC,EACL7B,SAAA0B,4BAAAA,2BAAA"}