{"version":3,"file":"bookit.min.js","sources":["../src/bookit.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/bookit\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\nvar currentbookitpage = {};\nvar totalbookitpages = {};\n\nvar SELECTORS = {\n    MODALID: '#sbPrePageModal',\n    INMODALDIV: ' div.pageContent',\n    CONTINUEBUTTON: 'a.continue-button',\n};\n\n/**\n * Gets called from mustache template.\n * @param {integer} optionid\n * @param {integer} totalnumberofpages\n */\nexport const init = (optionid, totalnumberofpages) => {\n\n    currentbookitpage[optionid] = 0;\n    totalbookitpages[optionid] = totalnumberofpages;\n\n    respondToVisibility(optionid, totalnumberofpages, loadPreBookingPage);\n};\n\n/**\n * React on visibility change.\n * @param {integer} optionid\n * @param {integer} totalnumberofpages\n * @param {function} callback\n */\nfunction respondToVisibility(optionid, totalnumberofpages, callback) {\n\n    if (totalnumberofpages < 1) {\n        return;\n    }\n\n    const selector = SELECTORS.MODALID + optionid + SELECTORS.INMODALDIV;\n    let element = document.querySelector(selector);\n\n    if (!element) {\n        return;\n    }\n\n    // eslint-disable-next-line no-console\n    console.log(selector, element);\n\n    var observer = new MutationObserver(function() {\n        if (!isHidden(element)) {\n            // this.disconnect();\n            callback(optionid, totalnumberofpages);\n        }\n    });\n\n    // We look if we find a hidden parent. If not, we load right away.\n    while (element !== null) {\n        if (!isHidden(element)) {\n            element = element.parentElement;\n        } else {\n            if (element.dataset.observed) {\n                return;\n            }\n\n            observer.observe(element, {attributes: true});\n            element.dataset.observed = true;\n            return;\n        }\n    }\n    callback(optionid, totalnumberofpages);\n}\n\n/**\n * Function to check visibility of element.\n * @param {*} el\n * @returns {boolean}\n */\nfunction isHidden(el) {\n    var style = window.getComputedStyle(el);\n    return ((style.display === 'none') || (style.visibility === 'hidden'));\n}\n\n/**\n * Loads the (next) pre booking page.\n * @param {integer} optionid\n * @param {integer} totalnumberofpages\n */\nexport const loadPreBookingPage = (\n    optionid, totalnumberofpages) => {\n\n    // eslint-disable-next-line no-console\n    console.log('loadPreBookingPage ' + optionid, totalnumberofpages);\n\n    // We need to clear the content of the div.\n    const selector = SELECTORS.MODALID + optionid + SELECTORS.INMODALDIV;\n\n    const element = document.querySelector(selector);\n\n    while (element.firstChild) {\n        element.removeChild(element.firstChild);\n    }\n\n    Ajax.call([{\n        methodname: \"mod_booking_load_pre_booking_page\",\n        args: {\n            'optionid': optionid,\n            'pagenumber': currentbookitpage[optionid],\n        },\n        done: function(res) {\n\n            const jsonobject = JSON.parse(res.json);\n\n            // We support more than one template, they will be seperated by comma.\n            // We have a data key in the json\n            const templates = res.template.split(',');\n            let dataarray = jsonobject;\n\n            templates.forEach(template => {\n\n                const data = dataarray.shift();\n\n                Templates.renderForPromise(template, data.data).then(({html, js}) => {\n\n                    Templates.appendNodeContents(selector, html, js);\n\n                    return true;\n                }).catch(ex => {\n                    Notification.addNotification({\n                        message: 'failed rendering ' + ex,\n                        type: \"danger\"\n                    });\n                });\n            });\n\n            showRightButton(optionid);\n\n            return true;\n        },\n        fail: function(err) {\n            // eslint-disable-next-line no-console\n            console.log(err);\n        }\n    }]);\n};\n\n/**\n * Reveal the hidden continue button.\n * @param {interger} optionid\n */\nfunction showRightButton(optionid) {\n\n    // eslint-disable-next-line no-console\n    console.log(optionid, currentbookitpage[optionid], totalbookitpages[optionid]);\n\n    if (currentbookitpage[optionid] + 1 < totalbookitpages[optionid]) {\n        const element = document.querySelector(SELECTORS.MODALID + optionid + ' ' + SELECTORS.CONTINUEBUTTON);\n        element.classList.remove('hidden');\n    } else {\n        const element = document.querySelector(SELECTORS.MODALID + optionid + ' ' + SELECTORS.CONTINUEBUTTON);\n        element.classList.add('hidden');\n    }\n\n}"],"names":["currentbookitpage","totalbookitpages","SELECTORS","isHidden","el","style","window","getComputedStyle","display","visibility","optionid","totalnumberofpages","callback","selector","element","document","querySelector","console","log","observer","MutationObserver","dataset","observed","observe","attributes","parentElement","respondToVisibility","loadPreBookingPage","firstChild","removeChild","call","methodname","args","done","res","jsonobject","JSON","parse","json","templates","template","split","dataarray","forEach","data","shift","renderForPromise","then","_ref","html","js","appendNodeContents","catch","ex","addNotification","message","type","classList","remove","add","showRightButton","fail","err"],"mappings":";;;;;wPAyBIA,kBAAoB,GACpBC,iBAAmB,GAEnBC,kBACS,kBADTA,qBAEY,mBAFZA,yBAGgB,6BAmEXC,SAASC,QACVC,MAAQC,OAAOC,iBAAiBH,UACT,SAAlBC,MAAMG,SAA6C,WAArBH,MAAMI,yBA7D7B,CAACC,SAAUC,sBAE3BX,kBAAkBU,UAAY,EAC9BT,iBAAiBS,UAAYC,4BAWJD,SAAUC,mBAAoBC,aAEnDD,mBAAqB,eAInBE,SAAWX,kBAAoBQ,SAAWR,yBAC5CY,QAAUC,SAASC,cAAcH,cAEhCC,eAKLG,QAAQC,IAAIL,SAAUC,aAElBK,SAAW,IAAIC,kBAAiB,WAC3BjB,SAASW,UAEVF,SAASF,SAAUC,4BAKR,OAAZG,SAAkB,IAChBX,SAASW,SAEP,IACCA,QAAQO,QAAQC,uBAIpBH,SAASI,QAAQT,QAAS,CAACU,YAAY,SACvCV,QAAQO,QAAQC,UAAW,GAP3BR,QAAUA,QAAQW,cAW1Bb,SAASF,SAAUC,oBA9CnBe,CAAoBhB,SAAUC,mBAAoBgB,2BAgEzCA,mBAAqB,CAC9BjB,SAAUC,sBAGVM,QAAQC,IAAI,sBAAwBR,SAAUC,0BAGxCE,SAAWX,kBAAoBQ,SAAWR,qBAE1CY,QAAUC,SAASC,cAAcH,eAEhCC,QAAQc,YACXd,QAAQe,YAAYf,QAAQc,0BAG3BE,KAAK,CAAC,CACPC,WAAY,oCACZC,KAAM,UACUtB,oBACEV,kBAAkBU,WAEpCuB,KAAM,SAASC,WAELC,WAAaC,KAAKC,MAAMH,IAAII,MAI5BC,UAAYL,IAAIM,SAASC,MAAM,SACjCC,UAAYP,kBAEhBI,UAAUI,SAAQH,iBAERI,KAAOF,UAAUG,2BAEbC,iBAAiBN,SAAUI,KAAKA,MAAMG,MAAKC,WAACC,KAACA,KAADC,GAAOA,mCAE/CC,mBAAmBtC,SAAUoC,KAAMC,KAEtC,KACRE,OAAMC,2BACQC,gBAAgB,CACzBC,QAAS,oBAAsBF,GAC/BG,KAAM,0BAoBL9C,aAGrBO,QAAQC,IAAIR,SAAUV,kBAAkBU,UAAWT,iBAAiBS,WAEhEV,kBAAkBU,UAAY,EAAIT,iBAAiBS,UAAW,CAC9CK,SAASC,cAAcd,kBAAoBQ,SAAW,IAAMR,0BACpEuD,UAAUC,OAAO,cACtB,CACa3C,SAASC,cAAcd,kBAAoBQ,SAAW,IAAMR,0BACpEuD,UAAUE,IAAI,WAzBlBC,CAAgBlD,WAET,GAEXmD,KAAM,SAASC,KAEX7C,QAAQC,IAAI4C"}