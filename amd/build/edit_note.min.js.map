{"version":3,"file":"edit_note.min.js","sources":["../src/edit_note.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AJAX helper for the inline editing a value.\n *\n * This script is automatically included from template core/inplace_editable\n * It registers a click-listener on [data-inplaceeditablelink] link (the \"inplace edit\" icon),\n * then replaces the displayed value with an input field. On \"Enter\" it sends a request\n * to web service core_update_inplace_editable, which invokes the specified callback.\n * Any exception thrown by the web service (or callback) is displayed as an error popup.\n *\n * @module     mod_booking/edit_note\n * @copyright  2018 David Bogner\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.3\n */\ndefine(['jquery',\n    'core/ajax',\n    'core/templates',\n    'core/notification',\n    'core/str',\n    'core/config',\n    'core/url'],\n    function($, ajax, templates, notification, str, cfg, url) {\n        $('body').on('click keypress', '[data-inplaceeditable]', function(e) {\n            if (e.type === 'keypress' && e.keyCode !== 13) {\n                return;\n            }\n            e.stopImmediatePropagation();\n            e.preventDefault();\n            var target = $(this),\n            mainelement = target.closest('[data-inplaceeditable]');\n            var addSpinner = function(element) {\n                element.addClass('updating');\n                var spinner = element.find('img.spinner');\n                if (spinner.length) {\n                    spinner.show();\n                } else {\n                    spinner = $('<img/>')\n                    .attr('src', url.imageUrl('i/loading_small'))\n                    .addClass('spinner').addClass('smallicon');\n                    element.append(spinner);\n                }\n            };\n\n            var removeSpinner = function(element) {\n                element.removeClass('updating');\n                element.find('img.spinner').hide();\n            };\n\n            var updateValue = function(mainelement, value) {\n                var pendingId = [\n                    mainelement.attr('data-baid'),\n                    'pending',\n                    ].join('-');\n                M.util.js_pending(pendingId);\n                addSpinner(mainelement);\n                ajax\n                .call([{\n                    methodname: 'mod_booking_update_bookingnotes',\n                    args: {\n                        baid: mainelement.attr('data-baid'),\n                        note: value\n                    },\n                    done: function(data) {\n                        var oldvalue = mainelement.attr('data-value');\n                        templates.render('mod_booking/edit_bookingnotes', data).done(function(html, js) {\n                            var newelement = $(html);\n                            templates.replaceNode(mainelement, newelement, js);\n                            newelement.find('[data-note]').focus();\n                            newelement.trigger({type: 'updated', ajaxreturn: data, oldvalue: oldvalue});\n                            M.util.js_complete(pendingId);\n                        });\n                    },\n                    fail: function(ex) {\n                        var e = $.Event('updatefailed', {\n                            exception: ex,\n                            newvalue: value\n                        });\n                        removeSpinner(mainelement);\n                        M.util.js_complete(pendingId);\n                        mainelement.trigger(e);\n                        if (!e.isDefaultPrevented()) {\n                            notification.exception(ex);\n                        }\n                    }\n                }], true);\n            };\n            var turnEditingOff = function(el) {\n                el.find('textarea').off();\n                el.html(el.attr('data-oldcontent'));\n                el.removeAttr('data-oldcontent');\n                el.removeClass('inplaceeditingon');\n                el.find('[data-note]').focus();\n            };\n\n            var turnEditingOn = function(el) {\n                el.attr('data-oldcontent', el.html());\n\n                var uniqueId = function(prefix, idlength) {\n                    var uniqid = prefix,\n                    i;\n                    for (i = 0; i < idlength; i++) {\n                        uniqid += String(Math.floor(Math.random() * 10));\n                    }\n                    // Make sure this ID is not already taken by an existing element.\n                    if ($(\"#\" + uniqid).length === 0) {\n                        return uniqid;\n                    }\n                    return uniqueId(prefix, idlength);\n                };\n\n                str.get_string('edittitleinstructions').done(function(s) {\n                    var instr = $('<span class=\"editinstructions\">' + s + '</span>').\n                    attr('id', uniqueId('id_editinstructions_', 20)),\n                    inputelement = $('<textarea rows=\"4\" cols=\"50\"></textarea>').\n                    attr('id', uniqueId('id_inplacevalue_', 20)).\n                    val(el.find('.bookingnote').text()).\n                    attr('aria-describedby', instr.attr('id')).\n                    addClass('ignoredirty').\n                    addClass('form-control'),\n                    lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>').\n                    attr('for', inputelement.attr('id'));\n                    el.html('').append(instr).append(lbl).append(inputelement);\n                    inputelement.focus();\n                    inputelement.select();\n                    inputelement.on('keyup keypress focusout', function(e) {\n                        if (cfg.behatsiterunning && e.type === 'focusout') {\n                            // Behat triggers focusout too often.\n                            return;\n                        }\n                        if (e.type === 'keypress' && e.keyCode === 13) {\n                            // We need 'keypress' event for Enter because keyup/keydown would catch Enter that was\n                            // pressed in other fields.\n                            var val = inputelement.val();\n                            turnEditingOff(el);\n                            updateValue(el, val);\n                        }\n                        if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                            // We need 'keyup' event for Escape because keypress does not work with Escape.\n                            turnEditingOff(el);\n                        }\n                    });\n                });\n            };\n            turnEditingOn(mainelement);\n        });\n        return {};\n    });\n"],"names":["define","$","ajax","templates","notification","str","cfg","url","on","e","type","keyCode","stopImmediatePropagation","preventDefault","mainelement","this","closest","updateValue","value","pendingId","attr","join","M","util","js_pending","element","addClass","spinner","find","length","show","imageUrl","append","addSpinner","call","methodname","args","baid","note","done","data","oldvalue","render","html","js","newelement","replaceNode","focus","trigger","ajaxreturn","js_complete","fail","ex","Event","exception","newvalue","removeClass","hide","isDefaultPrevented","turnEditingOff","el","off","removeAttr","uniqueId","prefix","idlength","i","uniqid","String","Math","floor","random","get_string","s","instr","inputelement","val","text","lbl","select","behatsiterunning","turnEditingOn"],"mappings":";;;;;;;;;;;;;;AA6BAA,+BAAO,CAAC,SACJ,YACA,iBACA,oBACA,WACA,cACA,aACA,SAASC,EAAGC,KAAMC,UAAWC,aAAcC,IAAKC,IAAKC,YACjDN,EAAE,QAAQO,GAAG,iBAAkB,0BAA0B,SAASC,MAC/C,aAAXA,EAAEC,MAAqC,KAAdD,EAAEE,SAG/BF,EAAEG,2BACFH,EAAEI,qBAEFC,YADab,EAAEc,MACMC,QAAQ,0BAmBzBC,YAAc,SAASH,YAAaI,WAChCC,UAAY,CACZL,YAAYM,KAAK,aACjB,WACEC,KAAK,KACXC,EAAEC,KAAKC,WAAWL,WAvBL,SAASM,SACtBA,QAAQC,SAAS,gBACbC,QAAUF,QAAQG,KAAK,eACvBD,QAAQE,OACRF,QAAQG,QAERH,QAAU1B,EAAE,UACXmB,KAAK,MAAOb,IAAIwB,SAAS,oBACzBL,SAAS,WAAWA,SAAS,aAC9BD,QAAQO,OAAOL,UAenBM,CAAWnB,aACXZ,KACCgC,KAAK,CAAC,CACHC,WAAY,kCACZC,KAAM,CACFC,KAAMvB,YAAYM,KAAK,aACvBkB,KAAMpB,OAEVqB,KAAM,SAASC,UACPC,SAAW3B,YAAYM,KAAK,cAChCjB,UAAUuC,OAAO,gCAAiCF,MAAMD,MAAK,SAASI,KAAMC,QACpEC,WAAa5C,EAAE0C,MACnBxC,UAAU2C,YAAYhC,YAAa+B,WAAYD,IAC/CC,WAAWjB,KAAK,eAAemB,QAC/BF,WAAWG,QAAQ,CAACtC,KAAM,UAAWuC,WAAYT,KAAMC,SAAUA,WACjEnB,EAAEC,KAAK2B,YAAY/B,eAG3BgC,KAAM,SAASC,QA7BM3B,QA8BbhB,EAAIR,EAAEoD,MAAM,eAAgB,CAC5BC,UAAWF,GACXG,SAAUrC,SAhCGO,QAkCHX,aAjCd0C,YAAY,YACpB/B,QAAQG,KAAK,eAAe6B,OAiCpBnC,EAAEC,KAAK2B,YAAY/B,WACnBL,YAAYkC,QAAQvC,GACfA,EAAEiD,sBACHtD,aAAakD,UAAUF,QAG/B,IAEJO,eAAiB,SAASC,IAC1BA,GAAGhC,KAAK,YAAYiC,MACpBD,GAAGjB,KAAKiB,GAAGxC,KAAK,oBAChBwC,GAAGE,WAAW,mBACdF,GAAGJ,YAAY,oBACfI,GAAGhC,KAAK,eAAemB,UAGP,SAASa,IACzBA,GAAGxC,KAAK,kBAAmBwC,GAAGjB,YAE1BoB,SAAW,SAASC,OAAQC,cAE5BC,EADIC,OAASH,WAERE,EAAI,EAAGA,EAAID,SAAUC,IACtBC,QAAUC,OAAOC,KAAKC,MAAsB,GAAhBD,KAAKE,kBAGN,IAA3BtE,EAAE,IAAMkE,QAAQtC,OACTsC,OAEJJ,SAASC,OAAQC,WAG5B5D,IAAImE,WAAW,yBAAyBjC,MAAK,SAASkC,OAC9CC,MAAQzE,EAAE,kCAAoCwE,EAAI,WACtDrD,KAAK,KAAM2C,SAAS,uBAAwB,KAC5CY,aAAe1E,EAAE,4CACjBmB,KAAK,KAAM2C,SAAS,mBAAoB,KACxCa,IAAIhB,GAAGhC,KAAK,gBAAgBiD,QAC5BzD,KAAK,mBAAoBsD,MAAMtD,KAAK,OACpCM,SAAS,eACTA,SAAS,gBACToD,IAAM7E,EAAE,6BAA+Ba,YAAYM,KAAK,kBAAoB,YAC5EA,KAAK,MAAOuD,aAAavD,KAAK,OAC9BwC,GAAGjB,KAAK,IAAIX,OAAO0C,OAAO1C,OAAO8C,KAAK9C,OAAO2C,cAC7CA,aAAa5B,QACb4B,aAAaI,SACbJ,aAAanE,GAAG,2BAA2B,SAASC,OAC5CH,IAAI0E,kBAA+B,aAAXvE,EAAEC,SAIf,aAAXD,EAAEC,MAAqC,KAAdD,EAAEE,QAAgB,KAGvCiE,IAAMD,aAAaC,MACvBjB,eAAeC,IACf3C,YAAY2C,GAAIgB,MAEJ,UAAXnE,EAAEC,MAAkC,KAAdD,EAAEE,SAA8B,aAAXF,EAAEC,OAE9CiD,eAAeC,WAK/BqB,CAAcnE,iBAEX"}