{"version":3,"file":"bookit copy.min.js","sources":["../src/bookit copy.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     mod_booking/bookit\n * @copyright  Wunderbyte GmbH <info@wunderbyte.at>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\n\nvar currentbookitpage = {};\nvar totalbookitpages = {};\n\nvar SELECTORS = {\n    MODALID: '#sbPrePageModal',\n    INMODALDIV: ' div.pageContent',\n    CONTINUEBUTTON: 'a.continue-button',\n    BACKBUTTON: 'a.back-button',\n    BOOKITBUTTON: 'div.booking-button-area',\n};\n\nexport const initbookitbutton = (itemid, area) => {\n\n    const buttons = document.querySelectorAll(SELECTORS.BOOKITBUTTON +\n        '[data-itemid=\"' + itemid + '\"]' +\n        '[data-area=\"' + area + '\"]');\n\n    const selector = SELECTORS.BOOKITBUTTON +\n    '[data-itemid=\"' + itemid + '\"]' +\n    '[data-area=\"' + area + '\"]';\n    // eslint-disable-next-line no-console\n    console.log(selector, buttons);\n\n    if (!buttons) {\n        return;\n    }\n\n    // We support more than one booking button on the same page.\n    buttons.forEach(button => {\n\n        if (button.dataset.nojs) {\n            return;\n        }\n\n        // eslint-disable-next-line no-console\n        console.log('add click listener ', button);\n        if (!button.dataset.initialized) {\n            button.dataset.initialized = 'true';\n\n            const userid = button.dataset.userid;\n\n            button.addEventListener('click', bookitbutton => {\n                // eslint-disable-next-line no-console\n                console.log('clicked ', bookitbutton.target);\n\n                bookit(itemid, area, userid);\n            });\n        }\n    });\n};\n\n/**\n * Gets called from mustache template.\n * @param {integer} optionid\n * @param {integer} totalnumberofpages\n */\nexport const initprepagemodal = (optionid, totalnumberofpages) => {\n\n    // eslint-disable-next-line no-console\n    console.log('initprepagemodal', optionid);\n\n    currentbookitpage[optionid] = 0;\n    totalbookitpages[optionid] = totalnumberofpages;\n\n    respondToVisibility(optionid, totalnumberofpages, loadPreBookingPage);\n\n    // We can add the click listener to the continue button right away.\n\n    initializeButton(optionid, true); // Back button.\n    initializeButton(optionid, false); // Continue button.\n};\n\n/**\n * React on visibility change.\n * @param {integer} optionid\n * @param {integer} totalnumberofpages\n * @param {function} callback\n */\nfunction respondToVisibility(optionid, totalnumberofpages, callback) {\n\n    if (totalnumberofpages < 1) {\n        return;\n    }\n\n    const selector = SELECTORS.MODALID + optionid + SELECTORS.INMODALDIV;\n    let element = document.querySelector(selector);\n\n    if (!element) {\n        return;\n    }\n\n    // eslint-disable-next-line no-console\n    // console.log(selector, element);\n\n    var observer = new MutationObserver(function() {\n        if (!isHidden(element)) {\n            // Todo: Make sure it's not triggered on close.\n            callback(optionid);\n        }\n    });\n\n    // We look if we find a hidden parent. If not, we load right away.\n    while (element !== null) {\n        if (!isHidden(element)) {\n            element = element.parentElement;\n        } else {\n            if (element.dataset.observed) {\n                return;\n            }\n\n            observer.observe(element, {attributes: true});\n            element.dataset.observed = true;\n            return;\n        }\n    }\n    callback(optionid, totalnumberofpages);\n}\n\n/**\n * Function to check visibility of element.\n * @param {*} el\n * @returns {boolean}\n */\nfunction isHidden(el) {\n    var style = window.getComputedStyle(el);\n    return ((style.display === 'none') || (style.visibility === 'hidden'));\n}\n\n/**\n * Loads the (next) pre booking page.\n * @param {integer} optionid\n */\nexport const loadPreBookingPage = (\n    optionid) => {\n\n    // eslint-disable-next-line no-console\n    // console.log('loadPreBookingPage ' + optionid, totalnumberofpages);\n\n    // We need to clear the content of the div.\n    const selector = SELECTORS.MODALID + optionid + SELECTORS.INMODALDIV;\n\n    const element = document.querySelector(selector);\n\n    while (element.firstChild) {\n        element.removeChild(element.firstChild);\n    }\n\n    Ajax.call([{\n        methodname: \"mod_booking_load_pre_booking_page\",\n        args: {\n            'optionid': optionid,\n            'pagenumber': currentbookitpage[optionid],\n        },\n        done: function(res) {\n\n            // eslint-disable-next-line no-console\n            // (res.json, \"template \" + res.template);\n\n            const jsonobject = JSON.parse(res.json);\n\n            // We support more than one template, they will be seperated by comma.\n            // We have a data key in the json\n            const templates = res.template.split(',');\n            let dataarray = jsonobject;\n\n            templates.forEach(template => {\n\n                const data = dataarray.shift();\n\n                if (!data) {\n                    return true;\n                }\n\n                // eslint-disable-next-line no-console\n                // console.log(data.data, \"template \" + template);\n\n                Templates.renderForPromise(template, data.data).then(({html, js}) => {\n\n                    // eslint-disable-next-line no-console\n                    // console.log(selector);\n\n                    Templates.appendNodeContents(selector, html, js);\n\n                    return true;\n                }).catch(ex => {\n                    Notification.addNotification({\n                        message: 'failed rendering ' + ex,\n                        type: \"danger\"\n                    });\n                });\n                return true;\n            });\n\n            showRightButton(optionid);\n\n            return true;\n        },\n        fail: function(err) {\n            // eslint-disable-next-line no-console\n            console.log(err);\n        }\n    }]);\n};\n\n/**\n * Reveal the hidden continue button.\n * @param {interger} optionid\n */\nfunction showRightButton(optionid) {\n\n    // eslint-disable-next-line no-console\n    // console.log(optionid, currentbookitpage[optionid], totalbookitpages[optionid]);\n\n    if (currentbookitpage[optionid] + 1 < totalbookitpages[optionid]) {\n        const element = document.querySelector(SELECTORS.MODALID + optionid + ' ' + SELECTORS.CONTINUEBUTTON);\n        element.classList.remove('hidden');\n    } else {\n        const element = document.querySelector(SELECTORS.MODALID + optionid + ' ' + SELECTORS.CONTINUEBUTTON);\n        element.classList.add('hidden');\n    }\n    if (currentbookitpage[optionid] > 0) {\n        const element = document.querySelector(SELECTORS.MODALID + optionid + ' ' + SELECTORS.BACKBUTTON);\n        element.classList.remove('hidden');\n    } else {\n        const element = document.querySelector(SELECTORS.MODALID + optionid + ' ' + SELECTORS.BACKBUTTON);\n        element.classList.add('hidden');\n    }\n\n}\n\n/**\n *\n * @param {integer} optionid\n * @param {boolean} show\n */\nexport function toggleContinueButton(optionid, show = null) {\n    const element = document.querySelector(SELECTORS.MODALID + optionid + ' ' + SELECTORS.CONTINUEBUTTON);\n\n    // If show is not defined yet, we define it automatically.\n    if (show === null) {\n        if (element.classList.contains('disabled')) {\n            show = true;\n        } else {\n            show = false;\n        }\n    }\n\n    // Now we add or remove the disabled class.\n    if (show) {\n        element.classList.remove('disabled');\n    } else {\n        element.classList.add('disabled');\n    }\n}\n\n/**\n * Add the click listener to a prepage modal button.\n * @param {integer} optionid\n * @param {bool} back // If it is the back button, it's true, else its continue.\n */\nfunction initializeButton(optionid, back) {\n    let selector = \"\";\n\n    if (back) {\n        selector = SELECTORS.MODALID + optionid + ' ' + SELECTORS.BACKBUTTON;\n    } else {\n        selector = SELECTORS.MODALID + optionid + ' ' + SELECTORS.CONTINUEBUTTON;\n    }\n\n    const element = document.querySelector(selector);\n\n    // eslint-disable-next-line no-console\n    // console.log(element, selector);\n\n    if (element && !element.dataset.prepageinit) {\n        element.dataset.prepageinit = true;\n\n        element.addEventListener('click', () => {\n\n            if (element.classList.contains('hidden')) {\n                return;\n            }\n\n            if (back) {\n                currentbookitpage[optionid]--;\n            } else {\n                currentbookitpage[optionid]++;\n            }\n\n            loadPreBookingPage(optionid);\n        });\n    }\n}\n\n/**\n *\n * @param {int} itemid\n * @param {string} area\n * @param {int} userid\n */\nfunction bookit(itemid, area, userid) {\n\n    Ajax.call([{\n        methodname: \"mod_booking_bookit\",\n        args: {\n            'itemid': itemid,\n            'area': area,\n            'userid': userid,\n        },\n        done: function(res) {\n\n            // eslint-disable-next-line no-console\n            console.log(res);\n\n            const jsonarray = JSON.parse(res.json);\n\n            // We might have more than one template to render.\n            const templates = res.template.split(',');\n\n            // There might be more than one button area.\n            const buttons = document.querySelectorAll(SELECTORS.BOOKITBUTTON +\n                '[data-itemid=\\'' + itemid + '\\']' +\n                '[data-area=\\'' + area + '\\']');\n\n            // We run through every button. and render the data.\n            buttons.forEach(button => {\n                while (button.firstChild) {\n                    const child = button.firstChild;\n                    child.remove();\n                }\n\n                templates.forEach(template => {\n                    const data = jsonarray.shift();\n\n                    const datatorender = data.data ?? data;\n\n                    // eslint-disable-next-line no-console\n                    console.log(datatorender);\n\n                    Templates.renderForPromise(template, datatorender).then(({html, js}) => {\n\n                        Templates.appendNodeContents(button, html, js);\n\n                        return true;\n                        }).catch(ex => {\n                            Notification.addNotification({\n                                message: 'failed rendering ' + ex,\n                                type: \"danger\"\n                            });\n                        });\n\n                    return true;\n                });\n            });\n        }\n    }]);\n}"],"names":["optionid","show","element","document","querySelector","SELECTORS","classList","contains","remove","add","currentbookitpage","totalbookitpages","itemid","area","buttons","querySelectorAll","selector","console","log","forEach","button","dataset","nojs","initialized","userid","addEventListener","bookitbutton","target","call","methodname","args","done","res","jsonarray","JSON","parse","json","templates","template","split","firstChild","data","shift","datatorender","renderForPromise","then","_ref2","html","js","appendNodeContents","catch","ex","addNotification","message","type","bookit","isHidden","el","style","window","getComputedStyle","display","visibility","totalnumberofpages","callback","observer","MutationObserver","observed","observe","attributes","parentElement","respondToVisibility","loadPreBookingPage","initializeButton","removeChild","jsonobject","dataarray","_ref","showRightButton","fail","err","back","prepageinit"],"mappings":"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"}